/*! @keithclark/shaderview v1.2.0 - Keith Clark - MIT license */
const e=(e,t,r,s)=>{e.postMessage({cmd:t,data:r},s)},t=(t,r,s,n=[])=>new Promise(((i,a)=>{const o=new MessageChannel;o.port1.onmessage=e=>{"ok"===e.data.status?i():a(new DOMException(e.data.reason||"Unhandled worker error"))},e(t,r,s,[o.port2,...n])})),r=new Map;class s extends HTMLElement{#e;#t;#r;#s;#n;#i;#a;#o;#h=null;#c=null;#m=0;#l=0;#d=!0;#u=!1;#f=new ResizeObserver((()=>{e(this.#e,"resize",{width:this.clientWidth,height:this.clientHeight})}));#p=new MutationObserver((()=>{this.#g()}));#w=new IntersectionObserver((t=>{this.#u=t[0].isIntersecting;const[r]=t,{target:s,isIntersecting:n}=r;n?(this.#f.observe(s),this.#d?e(this.#e,"setTime",this.#l):(e(this.#e,"setTime",performance.now()/1e3-this.#m),e(this.#e,"pause",!1))):(this.#f.unobserve(s),this.#d||e(this.#e,"pause",!0))}));constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML="<style>\n@layer {:host { width: 400px; height: 300px; display: inline-block }}\ndiv { position: relative; height: 100%; width:100%; user-select: none; overflow:hidden }\ncanvas { position: absolute; inset:0 }\n</style><div><canvas></canvas><slot hidden /></div>",this.#e=new Worker(URL.createObjectURL(new Blob(['class e extends Error{constructor(e,r=""){super(e),console.error(e+"\\n  "+r.replace(/\\n/g,"\\n  "))}}class r{#e;#r;#t;#n=new Map;constructor(e,r,t){if(!e instanceof WebGLRenderingContext)throw new Error("Argument 1 must be a WebGLRenderingContext");this.#e=e,this.#r=this.#o(r,t),this.#t=this.#i(this.#r)}#s(r,t){const n=this.#e,o=n.createShader(t);if(n.shaderSource(o,r),n.compileShader(o),!n.getShaderParameter(o,n.COMPILE_STATUS))throw new e(`Shader compilation failed (SHADER_TYPE=${t})`,n.getShaderInfoLog(o));return o}#o(r,t){const n=this.#e;n.clearColor(1,1,1,0);const o=this.#s(t,n.VERTEX_SHADER),i=this.#s(r,n.FRAGMENT_SHADER),s=n.createProgram();if(n.attachShader(s,o),n.attachShader(s,i),n.linkProgram(s),!n.getProgramParameter(s,n.LINK_STATUS))throw new e("Program link failed",n.getProgramInfoLog(s));n.useProgram(s);const a=new Float32Array([1,1,-1,1,1,-1,-1,-1]),c=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,c),n.bufferData(n.ARRAY_BUFFER,a,n.STATIC_DRAW);const f=n.getAttribLocation(s,"position");return n.enableVertexAttribArray(f),n.vertexAttribPointer(f,2,n.FLOAT,!1,0,0),s}#i=e=>{const r=new Map,t=this.#e,n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let o=0;o<n;o++){const{type:n,name:i}=t.getActiveUniform(e,o),s=t.getUniformLocation(e,i);let a;a=n===t.BOOL?e=>t.uniform1i(s,e?1:0):n===t.FLOAT?e=>t.uniform1f(s,e):n===t.FLOAT_VEC2?(...e)=>t.uniform2f(s,...e):n===t.FLOAT_VEC3?(...e)=>t.uniform3f(s,...e):n===t.FLOAT_VEC4?(...e)=>t.uniform4f(s,...e):n===t.INT?e=>t.uniform1i(s,e):n===t.INT_VEC2?(...e)=>t.uniform2i(s,...e):n===t.INT_VEC3?(...e)=>t.uniform3i(s,...e):n===t.INT_VEC4?(...e)=>t.uniform4i(s,...e):()=>{console.warn(`Uniform "${i}" is an unsupported type ${n}.`)},r.set(i,a)}return r};render(){const e=this.#e,{canvas:r}=e,{width:t,height:n}=r;for(const[e,r]of this.#n.entries())this.#t.get(e)?.(...r);this.#n.clear(),e.viewport(0,0,t,n),e.drawArrays(e.TRIANGLE_STRIP,0,4)}dispose(){const e=this.#e;e.clear(e.COLOR_BUFFER_BIT),e.deleteProgram(this.#r),this.#n.clear()}setUniform(e,...r){return!!this.#t.has(e)&&(this.#n.set(e,r),!0)}}const t=e=>{e.postMessage({status:"ok"})},n=(e,r)=>{e.postMessage({status:"fail",reason:r})},o="uTime",i="uResolution";let s,a,c,f=null,m=null,l=0,h=0,d=0,u=0;self.onmessage=e=>{const{cmd:f,data:m}=e.data,[g]=e.ports;if("setCanvas"===f){a=m;try{c=a.getContext("webgl"),t(g)}catch(e){n(g,"Unable to obtain a WebGL context")}}else if("setSource"===f)try{s=new r(c,m.fragmentSource,m.vertexSource),t(g),scheduleRender()}catch(e){s=null,n(g,e.message)}else if("resize"===f)l=m.width,h=m.height,scheduleRender();else if("pause"===f)!0===m?A():p();else if("setTime"===f)u=m,d=performance.now()/1e3-u,scheduleRender();else if("dispose"===f){if(!s)return;cancelRender(),A(),s.dispose(),s=null}else if("setUniform"===f){if(!s)return;const{name:e,values:r}=m;if(s.setUniform(e,...r))scheduleRender();else if(e!==i&&e!==o)throw new ReferenceError(`Uniform "${e}" does not exist.`)}},cancelRender=()=>{cancelAnimationFrame(f),f=null},scheduleRender=()=>{f||(f=requestAnimationFrame((()=>{f=null,g()})))};const g=()=>{s&&(l===a.width&&h===a.height||(a.width=l,a.height=h,s.setUniform(i,l,h)),s.setUniform(o,u),s.render())},p=()=>{if(m)return;d=performance.now()/1e3-u;const e=()=>{u=performance.now()/1e3-d,scheduleRender(),m=requestAnimationFrame(e)};e()},A=()=>{cancelAnimationFrame(m),m=null};\n']))),this.#t=this.shadowRoot.querySelector("canvas").transferControlToOffscreen(),this.#c=t(this.#e,"setCanvas",this.#t,[this.#t]),this.#c.catch((e=>{this.shadowRoot.querySelector("slot").hidden=!1}))}#v(){this.paused||this.pause(),this.#u=!1,this.#f.disconnect(),this.#w.disconnect(),e(this.#e,"dispose")}async#S(e,t){const r=await fetch(e,{priority:"low",signal:t});if(!r.ok)throw new Error("HTTP Error");return r.text()}async#b(e,t){if(!r.has(e)){let s;s=e.hasAttribute("src")?await this.#S(e.src,t):e.text,r.set(e,s)}return r.get(e)}async#g(){const e=this.querySelector('script[type="x-shader/x-fragment"]'),r=this.querySelector('script[type="x-shader/x-vertex"]');if(this.#n!==e||this._vertexShaderElem!==r){if(this.#n!==e&&(this.#n&&(this.#r?.abort(),this.#a=null),e&&(this.#r=new AbortController,this.#a=this.#b(e,this.#r.signal)),this.#n=e),this.#i!==r&&(this.#i&&(this.#s?.abort(),this.#o=null),r?(this.#s=new AbortController,this.#o=this.#b(r,this.#s.signal)):this.#o="attribute vec3 position;void main(){gl_Position=vec4(position,1);}",this.#i=r),!this.#a)return this.#v(),void(this.#h=null);this.#h=Promise.all([this.#a,this.#o,this.#c]).then((([e,r])=>(this.#v(),t(this.#e,"setSource",{fragmentSource:e,vertexSource:r}))));try{await this.#h,this.#w.observe(this),this.#f.observe(this),this.dispatchEvent(new Event("load")),this.hasAttribute("autoplay")&&this.play()}catch(e){"AbortError"!==e.name&&(this.#v(),this.#h=null,this.dispatchEvent(new Event("error")))}}}connectedCallback(){this.#g(),this.#p.observe(this,{childList:!0})}disconnectedCallback(){this.#v(),this.#p.disconnect()}get paused(){return this.#d}get time(){return this.#d?this.#l:performance.now()/1e3-this.#m}set time(t){this.#m=performance.now()/1e3-t,this.#l=t,this.#u&&e(this.#e,"setTime",t)}get autoplay(){return this.hasAttribute("autoplay")}set autoplay(e){this.toggleAttribute("autoplay",!!e)}get fragmentShader(){return this.#n}get vertexShader(){return this.#i}async play(){if(this.#d){if(!this.#h)throw new DOMException("InvalidStateError");try{await this.#h}catch(e){throw new DOMException("DataError")}this.#m=performance.now()/1e3-this.#l,e(this.#e,"pause",!1),this.#d=!1,this.dispatchEvent(new Event("playing"))}}pause(){this.#d||(this.#l=performance.now()/1e3-this.#m,this.#d=!0,e(this.#e,"pause",!0),this.dispatchEvent(new Event("pause")))}setUniform(t,...r){if("uResolution"===t||"uTime"===t)throw new DOMException(`Uniform "${t}" cannot be set externally`);e(this.#e,"setUniform",{name:t,values:r})}}export{s as default};
